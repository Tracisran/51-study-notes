/*
 * DS18B202a¨º?3¨¬D¨°
 * 
 * ¨®?¨ª?¡êo¨ºy??1¨¹?¡ê?¨¦2a¨º?3¨¬D¨°
 * 
 * ¡Á¡Â??					¨¨??¨²				¡À?¡Á¡é
 * Huafeng Lin			2012/04/21			D???
 * Huafeng Lin			2012/04/21			DT??
 * 
 */

#include <reg51.h>

#define uchar unsigned char

code unsigned char seg7code[]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90,0xff}; 	//2?¡ä?D?¨ºy¦Ì?¦Ì?12??¨ºy??1¨¹????
code unsigned char seg7codeB[]={0x40,0x79,0x24,0x30,0x19,0x12,0x02,0x78,0x00,0x10,0xff}; 	//¡ä?D?¨ºy¦Ì?¦Ì?12??¨ºy??1¨¹????

sbit DQ=P3^6; 				//¨ºy?Y¡ä?¨º????¨®¦Ì£¤???¨²¦Ì??¨¤¨®|¦Ì?¨°y?? 
unsigned char tempL=0; 		//¨¦¨¨¨¨???¡À?¨¢?
unsigned char tempH=0; 
unsigned int sdata;			//2a¨¢?¦Ì?¦Ì????¨¨¦Ì???¨ºy2?¡¤?
unsigned char xiaoshu1;		//D?¨ºy¦Ì¨²¨°???
unsigned char xiaoshu2;		//D?¨ºy¦Ì¨²?t??
unsigned char xiaoshu;		//¨¢???D?¨ºy
bit fg=1;        			//???¨¨?y?o¡À¨º??

void delay(unsigned char i)
{
	for(i;i>0;i--);
}

void delay1(uchar i)
{
	uchar j,k; 
	for(j=i;j>0;j--)
		for(k=125;k>0;k--);
}

void Init_DS18B20(void) 
{
	unsigned char x=0;
	DQ=1; 					//DQ?¨¨???? 
	delay(8); 				//¨¦??¨®¨º¡À
	DQ=0; 					//¡¤¡é?¨ª?¡ä????3? 
	delay(80); 				//?¨®¨º¡À¡ê¡§>480us) 
	DQ=1; 					//¨¤-??¨ºy?Y?? 
	delay(5); 				//¦Ì¨¨¡äy¡ê¡§15~60us) 
	x=DQ; 					//¨®?X¦Ì??¦Ì¨¤¡ä?D??3?¨º??¡¥¨®D??¨®D3¨¦1|¡ê?18B20¡ä??¨²¦Ì??¡ãX=0¡ê?¡¤??¨°X=1 
	delay(20); 
}

//?¨¢¨°???¡Á??¨²
ReadOneChar(void)  			//?¡Â?¨²¨ºy?Y???¨¨¡ä¨®??¨¤-?¨¢¦Ì¨ª¦Ì???1us¨°?¨¦?¡ê??¨´¨º1¨ºy?Y??¨¦y?a??¦Ì???¡ê?¡ä¨®??2¨²¨¦¨²?¨¢D?o?
{
	unsigned char i=0; 		//?????¨¢?¨¹?¨²¡Á??¨¬¦Ì?3?D?¨º¡À???a60us¡ê??¡Â???¨¢?¨¹?¨²????¡À?D?¨®D1us¨°?¨¦?¦Ì???¦Ì??????¡ä?¨²
	unsigned char dat=0; 
	for (i=8;i>0;i--) 		//¨°???¡Á??¨²¨®D8?? 
	{
		DQ=1; 
		delay(1); 
		DQ=0;
		dat>>=1; 
		DQ=1; 
		if(DQ) 
		dat|=0x80; 
		delay(4);
	} 
	return(dat);
}

//D¡ä¨°???¡Á??¨²
void WriteOneChar(unsigned char dat) 
{ 
	unsigned char i=0; 		//¨ºy?Y??¡ä¨®??¦Ì???¨¤-?¨¢¦Ì¨ª¦Ì???¡ê?2¨²¨¦¨²D¡ä?e¨º?D?o??¡ê15us???¨²???¨´D¨¨D¡ä¦Ì????¨ª¦Ì?¨ºy?Y??¨¦?¡ê?
	for(i=8;i>0;i--) 		//?¨²15~60us??????¨ºy?Y????DD2¨¦?¨´¡ê?¨¨?1?¨º???¦Ì????¨ªD¡ä1¡ê?¦Ì¨ªD¡ä0¡¤¡é¨¦¨²?¡ê 
	{
		DQ=0; 				//?¨²?a¨º?¨¢¨ª¨°???D¡ä?¨¹?¨²?¡ã¡À?D?¨®D1us¨°?¨¦?¦Ì???¦Ì??????¡ä?¨²?¡ê 
		DQ=dat&0x01; 
		delay(5); 
		DQ=1; 
		dat>>=1;
	} 
	delay(4);
}

//?¨¢???¨¨?¦Ì¡ê¡§¦Ì¨ª??¡¤?tempL;????¡¤?tempH;¡ê?
void ReadTemperature(void) 
{ 
	Init_DS18B20(); 					//3?¨º??¡¥
	WriteOneChar(0xcc); 				//¨¬?1y?¨¢D¨°¨¢Do?¦Ì?2¨´¡Á¡Â
	WriteOneChar(0x44); 				//???¡¥???¨¨¡Áa??
	delay(125); 						//¡Áa??D¨¨¨°a¨°?¦Ì?¨º¡À??¡ê??¨®¨º¡À 
	Init_DS18B20(); 					//3?¨º??¡¥
	WriteOneChar(0xcc); 				//¨¬?1y?¨¢D¨°¨¢Do?¦Ì?2¨´¡Á¡Â 
	WriteOneChar(0xbe); 				//?¨¢???¨¨??¡ä??¡Â¡ê¡§¨ª¡¤¨¢????¦Ì¡¤?¡Àe?a???¨¨¦Ì?¦Ì¨ª??o¨ª????¡ê? 
	tempL=ReadOneChar(); 				//?¨¢3????¨¨¦Ì?¦Ì¨ª??LSB
	tempH=ReadOneChar(); 				//?¨¢3????¨¨¦Ì?????MSB	
	if(tempH>0x7f)      				//¡Á??????a1¨º¡À???¨¨¨º??o
	{
		tempL=~tempL;					//21??¡Áa??¡ê?¨¨?¡¤¡ä?¨®¨°?
		tempH=~tempH+1;       
		fg=0;      						//?¨¢¨¨????¨¨?a?o¨º¡Àfg=0
	}
	sdata = tempL/16+tempH*16;      	//??¨ºy2?¡¤?
	xiaoshu1 = (tempL&0x0f)*10/16; 		//D?¨ºy¦Ì¨²¨°???
	xiaoshu2 = (tempL&0x0f)*100/16%10;	//D?¨ºy¦Ì¨²?t??
	xiaoshu=xiaoshu1*10+xiaoshu2; 		//D?¨ºy¨¢???
}

//??¨º?o¡¥¨ºy
void Led(unsigned int date)
{ 
	if(fg==1)
	{
		P2=0xfe;     			//P1.0=0¡ê???¨ª¡§¦Ì¨²¨°???
		P0=seg7code[date/10];  	//¨º???¨ºy¡ê?2¨¦¡À¨ª¡ê?¨º?3?
		delay1(5);
		P0=0xff;        		//??¨°t
		
		P2=0xfd;     			//P1.1=0,??¨ª¡§¦Ì¨²?t??¡ê?????¨ºy
		P0=seg7codeB[date%10];
		delay1(5);
		P0=0xff;       			//??¨°t
		
		P2=0xfb;     			//P1.3=0,??¨ª¡§¦Ì¨²¨¨y??¡ê?D?¨ºy¦Ì?¦Ì¨²¨°???
		P0=seg7code[xiaoshu1];
		delay1(5);
		P0=0xff;         		//??¨°t
		
		P2=0xf7;     			//P1.3=0,??¨ª¡§¦Ì¨²????¡ê?D?¨ºy¦Ì?¦Ì¨²?t??
		P0=seg7code[xiaoshu2];
		delay1(5);
		P0=0xff;       			//??¨°t
	}
		
	if(fg==0)  					//???¨¨?a?o¨º¡À??¨º?¦Ì?¨ºy?Y
	{
		P2=0xfe;     			//P1.0=0¡ê???¨ª¡§¦Ì¨²¨°???
		P0=seg7code[11];  		//??¨º??oo?
		delay1(5);
		P0=0xff;        		//??¨°t
		
		P2=0xfd;     			//P1.1=0,??¨ª¡§¦Ì¨²?t??¡ê?¨º???¨ºy
		P0=seg7code[date/10];
		delay1(5);
		P0=0xff;       			//??¨°t
		
		P2=0xfb;     			//P1.3=0,??¨ª¡§¦Ì¨²¨¨y??¡ê?????¨ºy
		P0=seg7codeB[date%10];
		delay1(5);
		P0=0xff;         		//??¨°t
		
		P2=0xf7;     			//P1.3=0,??¨ª¡§¦Ì¨²????¡ê?D?¨ºy¦Ì?¦Ì¨²¨°???
		P0=seg7code[xiaoshu1];
		delay1(5);
		P0=0xff;       			//??¨°t
	}
}

main()
{
	while(1)
	{
		ReadTemperature();
		Led(sdata);
	}
}